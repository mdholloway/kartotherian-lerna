<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE Map[]>
<Map srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">

<Parameters>
  <Parameter name="center">-123.316,37.6371,9</Parameter>
  <Parameter name="format">pbf</Parameter>
  <Parameter name="json"><![CDATA[{"vector_layers":[{"id":"landuse","description":"","fields":{"osm_id":"Number","class":"String","z_order":"Number","way_area":"Number"}},{"id":"waterway","description":"","fields":{"osm_id":"Number","class":"String"}},{"id":"water","description":"","fields":{"osm_id":"Number"}},{"id":"aeroway","description":"","fields":{"osm_id":"Number","type":"String"}},{"id":"building","description":"","fields":{"osm_id":"Number"}},{"id":"tunnel","description":"","fields":{"osm_id":"Number","class":"String"}},{"id":"road","description":"","fields":{"osm_id":"Number","class":"String"}},{"id":"bridge","description":"","fields":{"osm_id":"Number","class":"String"}},{"id":"admin","description":"","fields":{"osm_id":"Number","admin_level":"String","maritime":"Number"}},{"id":"country_label","description":"","fields":{"osm_id":"Number","name_en":"String","scalerank":"Number"}},{"id":"place_label","description":"","fields":{"osm_id":"Number","name_en":"String","type":"String","ldir":"String","localrank":"Number"}},{"id":"road_label","description":"","fields":{"osm_id":"Number","shield":"String","name_en":"String","ref":"String","reflen":"Number","len":"Number"}}]}]]></Parameter>
  <Parameter name="maxzoom">16</Parameter>
  <Parameter name="minzoom">0</Parameter>
  <Parameter name="name"><![CDATA[osm2pgsql-osm-bright]]></Parameter>
</Parameters>


<Layer name="landuse"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT * FROM (
SELECT osm_id, way, landuse AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    landuse IN ('cemetery', 'industrial')
    AND mb_z(!scale_denominator!) >= 10
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'industrial' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    aeroway IS NOT NULL
    AND mb_z(!scale_denominator!) >= 10
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'hospital' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    amenity = 'hospital'
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
-- TODO: conservation???
SELECT osm_id, way, 'park' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    landuse = 'village_green'
    AND mb_z(!scale_denominator!) >= 10
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'park' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    leisure IN ('park', 'playground')
    AND mb_z(!scale_denominator!) >= 10
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'park' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    leisure IN ('national_reserve', 'nature_reserve', 'golf_course')
    AND mb_z(!scale_denominator!) >= 7
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'park' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    boundary = 'national_park'
    AND mb_z(!scale_denominator!) >= 7
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'school' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    amenity IN ('school', 'university')
    AND mb_z(!scale_denominator!) >= 10
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'wood' AS class, z_order, way_area
  FROM planet_osm_polygon
  WHERE
    landuse IN ('wood', 'forest')
    AND mb_z(!scale_denominator!) >= 7
    AND way && !bbox!
) united_select ORDER BY z_order, way_area DESC
) landuse]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="waterway"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, waterway AS class
  FROM planet_osm_line
  WHERE waterway IN ('river', 'canal')
  AND mb_z(!scale_denominator!) >= 8
  AND way && !bbox!
UNION ALL
SELECT osm_id, way, waterway AS class
  FROM planet_osm_line
  WHERE waterway IN ('stream', 'stream_intermittent')
  AND mb_z(!scale_denominator!) >= 13
  AND way && !bbox!
) waterway]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="water"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[way]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way
  FROM planet_osm_polygon
  WHERE
    (
      "natural" IN ('water', 'bay')
      OR waterway IS NOT NULL
      OR landuse = 'reservoir'
      OR landuse = 'pond'
    )
    AND
    (
      mb_z(!scale_denominator!) >= 14
      OR way_area >= 5000000000 / 2.3^mb_z(!scale_denominator!)
    )
    AND way && !bbox!
UNION ALL
SELECT 0 AS osm_id, way
  FROM water_polygons
  WHERE
    way && !bbox!
) water]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="aeroway"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, aeroway AS type
  FROM planet_osm_polygon
  WHERE
    aeroway IS NOT NULL
    AND aeroway <> 'aerodrome'
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, aeroway AS type
  FROM planet_osm_line
  WHERE
    aeroway IS NOT NULL
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
) aeroway]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="building"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
  SELECT osm_id, way
    FROM planet_osm_polygon
    WHERE
      mb_z(!scale_denominator!) >= 14
      AND building IS NOT NULL
      AND building <> 'no'
      AND way && !bbox!
) building]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="tunnel"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, 'motorway' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('motorway')
    AND mb_z(!scale_denominator!) >= 5
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'motorway_link' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('motorway_link')
    AND mb_z(!scale_denominator!) >= 13
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('primary', 'primary_link', 'trunk', 'trunk_link')
    AND mb_z(!scale_denominator!) >= 5
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('secondary', 'secondary_link')
    AND mb_z(!scale_denominator!) >= 9
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('tertiary', 'tertiary_link')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('residential', 'unclassified', 'living_street')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street_limited' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND (highway IN ('pedestrian', 'construction') or access = 'private')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'service' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('service', 'track')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'driveway' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('driveway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'path' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('path', 'cycleway', 'ski', 'steps', 'bridleway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'major_rail' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('rail', 'monorail', 'narrow_gauge', 'subway', 'tram')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'minor_rail' AS class
  FROM  planet_osm_line
  WHERE
    tunnel IS NOT NULL
    AND tunnel <> 'no'
    AND highway IN ('funicular', 'light_rail', 'preserved')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
) tunnel]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="road"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[way]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, 'motorway' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('motorway')
    AND mb_z(!scale_denominator!) >= 5
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'motorway_link' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('motorway_link')
    AND mb_z(!scale_denominator!) >= 13
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('primary', 'primary_link', 'trunk', 'trunk_link')
    AND mb_z(!scale_denominator!) >= 7
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('secondary', 'secondary_link')
    AND mb_z(!scale_denominator!) >= 9
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('tertiary', 'tertiary_link')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('residential', 'unclassified', 'living_street')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('residential', 'unclassified', 'living_street')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street_limited' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND (highway IN ('pedestrian', 'construction') or access = 'private')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'service' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('service', 'track')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'driveway' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('driveway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'path' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND highway IN ('path', 'cycleway', 'ski', 'steps', 'bridleway', 'footway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'major_rail' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND railway IN ('rail', 'monorail', 'narrow_gauge', 'subway', 'tram')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'minor_rail' AS class
  FROM  planet_osm_line
  WHERE
    (bridge IS NULL OR bridge = 'no')
    AND (tunnel IS NULL OR tunnel = 'no')
    AND railway IN ('funicular', 'light_rail', 'preserved')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
) road
]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="bridge"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, 'motorway' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('motorway')
    AND mb_z(!scale_denominator!) >= 5
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'motorway_link' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('motorway_link')
    AND mb_z(!scale_denominator!) >= 13
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('primary', 'primary_link', 'trunk', 'trunk_link')
    AND mb_z(!scale_denominator!) >= 5
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('secondary', 'secondary_link')
    AND mb_z(!scale_denominator!) >= 9
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'main' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('tertiary', 'tertiary_link')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('residential', 'unclassified', 'living_street')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'street_limited' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND (highway IN ('pedestrian', 'construction') or access = 'private')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'service' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('service', 'track')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'driveway' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('driveway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'path' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('path', 'cycleway', 'ski', 'steps', 'bridleway')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'major_rail' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('rail', 'monorail', 'narrow_gauge', 'subway', 'tram')
    AND mb_z(!scale_denominator!) >= 12
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, 'minor_rail' AS class
  FROM  planet_osm_line
  WHERE
    bridge IS NOT NULL
    AND bridge <> 'no'
    AND highway IN ('funicular', 'light_rail', 'preserved')
    AND mb_z(!scale_denominator!) >= 15
    AND way && !bbox!
) bridge]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="admin"
  buffer-size="8"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT
    r.osm_id, r.way,
    CAST (r.admin_level AS SMALLINT),
    CASE
      WHEN r.tags->'maritime' = 'yes' THEN 1
      ELSE
        CASE WHEN w.way IS NULL THEN 0 ELSE 1 END
    END AS maritime
  FROM planet_osm_roads r LEFT JOIN water_polygons w ON r.way && w.way
  WHERE
    boundary = 'administrative'
    AND (
      ( admin_level = '2' AND mb_z(!scale_denominator!) >= 2 )
      OR ( admin_level = '4' AND mb_z(!scale_denominator!) >= 3 )
    )
    AND r.way && !bbox!
) admin]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="country_label"
  buffer-size="64"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, way, name AS name_en, CASE
      WHEN CAST(population AS int) >= 250000000 THEN 1
      WHEN CAST(population AS int) >= 100000000 AND CAST(population AS int) < 250000000 THEN 2
      WHEN CAST(population AS int) >= 50000000 AND CAST(population AS int) < 100000000 THEN 3
      WHEN CAST(population AS int) >= 25000000 AND CAST(population AS int) < 50000000 THEN 4
      WHEN CAST(population AS int) >= 10000000 AND CAST(population AS int) < 25000000 THEN 5
      WHEN CAST(population AS int) < 10000000 THEN 6
    END scalerank
  FROM planet_osm_point
  WHERE
    place = 'country'
    AND mb_z(!scale_denominator!) < 12
    AND way && !bbox!
) country_label]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="place_label"
  buffer-size="64"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT DISTINCT ON(mb_labelgrid(way, 64, 1)) * FROM(
/* TODO calculate real ranks and ldir */
SELECT osm_id, way, name AS name_en, place AS "type",
    'SE' AS ldir, 1 AS localrank
  FROM planet_osm_point
  WHERE
    place = 'city'
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, name AS name_en, place AS "type",
    'SE' AS ldir, 1 AS localrank
  FROM planet_osm_point
  WHERE
    place = 'town'
    AND mb_z(!scale_denominator!) >= 7
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, name AS name_en, place AS "type",
    'SE' AS ldir, 1 AS localrank
  FROM planet_osm_point
  WHERE
    place = 'village'
    AND mb_z(!scale_denominator!) >= 11
    AND way && !bbox!
UNION ALL
SELECT osm_id, way, name AS name_en, place AS "type",
    'SE' AS ldir, 1 AS localrank
  FROM planet_osm_point
  WHERE
    place IN ('hamlet', 'suburb','neighbourhood')
    AND mb_z(!scale_denominator!) >= 13
    AND way && !bbox!
) data
) place_label]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

<Layer name="road_label"
  buffer-size="64"
  srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs +over">
    
    <Datasource>
       <Parameter name="dbname"><![CDATA[gis]]></Parameter>
       <Parameter name="extent"><![CDATA[-20037508.34,-20037508.34,20037508.34,20037508.34]]></Parameter>
       <Parameter name="geometry_field"><![CDATA[]]></Parameter>
       <Parameter name="geometry_table"><![CDATA[]]></Parameter>
       <Parameter name="host"><![CDATA[]]></Parameter>
       <Parameter name="key_field"><![CDATA[]]></Parameter>
       <Parameter name="max_size"><![CDATA[512]]></Parameter>
       <Parameter name="password"><![CDATA[]]></Parameter>
       <Parameter name="port"><![CDATA[]]></Parameter>
       <Parameter name="table"><![CDATA[(
SELECT osm_id, 'default' AS shield, way, name AS name_en, ref, char_length(ref) AS reflen,
  ROUND(mb_merc_length(way)) AS len
  FROM planet_osm_roads
  WHERE
    highway IN ('motorway', 'primary', 'primary_link', 'trunk', 'trunk_link', 'secondary', 'secondary_link', 'tertiary', 'tertiary_link', 'residential', 'unclassified', 'living_street')
    AND ( name IS NOT NULL OR ref IS NOT NULL)
    AND mb_z(!scale_denominator!) >= 11
    --AND mb_linelabel(mb_z(!scale_denominator!), name, way)
    AND way && !bbox!
UNION ALL
SELECT osm_id, 'default' AS shield, way, name AS name_en, '' AS ref, 0 AS reflen,
  ROUND(mb_merc_length(way)) AS len
  FROM planet_osm_roads
  WHERE
    highway IN ('motorway_link')
    AND name IS NOT NULL
    AND mb_z(!scale_denominator!) >= 13
    --AND mb_linelabel(mb_z(!scale_denominator!), name, way)
    AND way && !bbox!
UNION ALL
SELECT osm_id, 'default' AS shield, way, name AS name_en, '' AS ref, 0 AS reflen,
  ROUND(mb_merc_length(way)) AS len
  FROM planet_osm_roads
  WHERE
    highway IN ('service', 'track', 'driveway', 'path', 'cycleway', 'ski', 'steps', 'bridleway')
    AND name IS NOT NULL
    AND mb_z(!scale_denominator!) >= 15
    --AND mb_linelabel(mb_z(!scale_denominator!), name, way)
    AND way && !bbox!
) AS road_label
]]></Parameter>
       <Parameter name="type"><![CDATA[postgis]]></Parameter>
       <Parameter name="user"><![CDATA[]]></Parameter>
    </Datasource>
  </Layer>

</Map>